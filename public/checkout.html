<!DOCTYPE html>
<html>
<head>
  <title>checkout</title>
  <script src="./js/jquery-1.8.2.js"></script>
  <script src="https://unpkg.com/jquery-mask-plugin@1.14.11/dist/jquery.mask.js"></script>
  <script src="https://unpkg.com/jquery-validation@1.17.0/dist/jquery.validate.js"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <h1>checkout</h1>
  <form id="checkout_form" novalidate="novalidate" class="simple_form new_order" action="/checkout" accept-charset="UTF-8" method="post">

    <!-- 1. utf8 -->
    <input name="utf8" type="hidden" value="&#x2713;" />

    <!-- 2. authenticity_token -->
    <input type="hidden" name="authenticity_token" value="A8FYgbI5Bgjfx1jtP+mcrDMIe84WLmKeTd2vytIir70bNJpl2RokFe4kgN78V+W3kVf/du5DR55kBt89Q7TWAQ==" />
    <div id="cart-header">
      <div id="tabs">
        <div class="tab tab-edit-link"><a href="http://www.supremenewyork.com/shop/cart">EDIT / VIEW CART</a></div>
        <div class="tab tab-payment selected"><b>SHIPPING / PAYMENT</b></div>
        <div class="tab tab-confirmation "><b>CONFIRMATION</b></div>
      </div>
    </div>
    <div class="payment" id="cart-body">
      <div id="cart-address">
        <h2><b>billing/shipping information</b></h2>
        <fieldset>
          <p>must be the same as your credit card address</p>
          <div class="input string required order_billing_name">
            <label class="string required control-label floaty" for="order_billing_name">name</label>

            <!-- 3. order[billing_name] (#order_billing_name) -->
            <input first_and_last="true" placeholder="name" class="string required" type="text" name="order[billing_name]" id="order_billing_name" />
          </div>
          <div class="input email required order_email">
            <label class="email required control-label floaty" for="order_email">email</label>

            <!-- 4. order[email] (#order_email) -->
            <input placeholder="email" class="string email required" type="email" name="order[email]" id="order_email" />
          </div>
          <div class="input string required order_tel">
            <label class="string required control-label floaty" for="order_tel">tel</label>

            <!-- 5. order[tel] (#order_tel) -->
            <input tel="true" placeholder="tel" class="string required" type="text" name="order[tel]" id="order_tel" />
          </div>
          <div id="address_row">
            <div class="input string required order_billing_address">
              <label class="string required control-label floaty" for="bo">address</label>

              <!-- 6. order[billing_address] (#bo) -->
              <input id="bo" placeholder="address" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" class="string required" type="text" name="order[billing_address]" />
            </div>
            <div class="input string optional order_billing_address_2">
              <label class="string optional control-label floaty" for="oba3">apt, unit, etc</label>

              <!-- 7. order[billing_address_2] (#oba3) -->
              <input id="oba3" placeholder="apt, unit, etc" class="string optional" type="text" name="order[billing_address_2]" />
            </div>
          </div>
          <div id="zip_city_state_row">
            <div class="input string required order_billing_zip">
              <label id="zip_label" class="string required control-label floaty" for="order_billing_zip">zip</label>

              <!-- 8. order[billing_zip] (#order_billing_zip) -->
              <input autocomplete="off" zipcode="true" size="5" placeholder="zip" class="string required" type="text" name="order[billing_zip]" id="order_billing_zip" />
            </div>
            <div class="input string required order_billing_city">
              <label class="string required control-label floaty" for="order_billing_city">city</label>

              <!-- 9. order[billing_city] (#order_billing_city) -->
              <input placeholder="city" class="string required" type="text" name="order[billing_city]" id="order_billing_city" />
            </div>
            <div class="input select optional order_billing_state">
              <label id="state_label" class="select optional control-label floaty" for="order_billing_state">state</label>

              <!-- 10. order[billing_state] (#order_billing_state) -->
              <select class="select optional" name="order[billing_state]" id="order_billing_state">
                <option value="AL">AL</option>
                <option value="AK">AK</option>
                <option value="AS">AS</option>
                <option value="AZ">AZ</option>
                <option value="AR">AR</option>
                <option value="CA">CA</option>
                <option value="CO">CO</option>
                <option value="CT">CT</option>
                <option value="DE">DE</option>
                <option value="DC">DC</option>
                <option value="FM">FM</option>
                <option value="FL">FL</option>
                <option value="GA">GA</option>
                <option value="GU">GU</option>
                <option value="HI">HI</option>
                <option value="ID">ID</option>
                <option value="IL">IL</option>
                <option value="IN">IN</option>
                <option value="IA">IA</option>
                <option value="KS">KS</option>
                <option value="KY">KY</option>
                <option value="LA">LA</option>
                <option value="ME">ME</option>
                <option value="MH">MH</option>
                <option value="MD">MD</option>
                <option value="MA">MA</option>
                <option value="MI">MI</option>
                <option value="MN">MN</option>
                <option value="MS">MS</option>
                <option value="MO">MO</option>
                <option value="MT">MT</option>
                <option value="NE">NE</option>
                <option value="NV">NV</option>
                <option value="NH">NH</option>
                <option value="NJ">NJ</option>
                <option value="NM">NM</option>
                <option value="NY">NY</option>
                <option value="NC">NC</option>
                <option value="ND">ND</option>
                <option value="MP">MP</option>
                <option value="OH">OH</option>
                <option value="OK">OK</option>
                <option value="OR">OR</option>
                <option value="PW">PW</option>
                <option value="PA">PA</option>
                <option value="PR">PR</option>
                <option value="RI">RI</option>
                <option value="SC">SC</option>
                <option value="SD">SD</option>
                <option value="TN">TN</option>
                <option value="TX">TX</option>
                <option value="UT">UT</option>
                <option value="VT">VT</option>
                <option value="VI">VI</option>
                <option value="VA">VA</option>
                <option value="WA">WA</option>
                <option value="WV">WV</option>
                <option value="WI">WI</option>
                <option value="WY">WY</option>
              </select>
            </div>
          </div>
          <div class="input select optional order_billing_country">
            <label class="select optional control-label floaty" for="order_billing_country">country</label>

            <!-- 11. order[billing_country] (order_billing_country) -->
            <select class="select optional" name="order[billing_country]" id="order_billing_country">
              <option selected="selected" value="USA">USA</option>
              <option value="CANADA">CANADA</option>
            </select>
          </div>

          <!-- 12. asec (#asec) -->
          <input type="hidden" name="asec" id="asec" value="Rmasn" />

          <!-- 13. same_as_billing_address (#same_as_billing_address) -->
          <input type="hidden" name="same_as_billing_address" id="same_as_billing_address" value="1" />

          <!-- 14. store_credit_id (#store_credit_id) -->
          <input type="hidden" name="store_credit_id" id="store_credit_id" value="" />
          <div class="input string optional store-address-checkbox">

            <!-- 15. store_address (#store_address) [OPTIONAL] -->
            <input type="checkbox" name="store_address" id="store_address" value="1" class="checkbox" />
            <label class="string optional control-label" for="store_address" id="store-address">save address for future orders</label>
          </div>
          <div id="shipping-address"></div>
        </fieldset>
      </div>
      <div id="cart-cc">
        <h2><b>credit card information</b></h2>
        <fieldset>
          <p class="errors">&nbsp;</p>
          <div id="card_details">
            <div class="input string required credit_card_number">
              <label class="nlb string required sr-label floaty" for="nnaerb">number</label>

              <!-- 16. credit_card[nlb] (#nnaerb) -->
              <input placeholder="number" id="nnaerb" name="credit_card[nlb]" class="string required" type="text" />
            </div>
            <div id="cvv_row">
              <div class="input string required credit_card_month">
                <label class="string required control-label floaty" for="credit_card_month">exp. date</label>

                <!-- 17. credit_card[month] (#credit_card_month) -->
                <select name="credit_card[month]" id="credit_card_month">
                  <option value="01">01</option>
                  <option value="02">02</option>
                  <option value="03">03</option>
                  <option value="04">04</option>
                  <option value="05">05</option>
                  <option value="06">06</option>
                  <option value="07">07</option>
                  <option value="08">08</option>
                  <option selected="selected" value="09">09</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                </select>

                <!-- 18. credit_card[year] (#credit_card_year) -->
                <select name="credit_card[year]" id="credit_card_year">
                  <option value="2018">2018</option>
                  <option value="2019">2019</option>
                  <option value="2020">2020</option>
                  <option value="2021">2021</option>
                  <option value="2022">2022</option>
                  <option value="2023">2023</option>
                  <option value="2024">2024</option>
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                  <option value="2027">2027</option>
                  <option value="2028">2028</option>
                </select>
              </div>
              <div id="rmae" class="input string required credit_card_verification_value">
                <label class="nclb string required sr-label floaty" for="orcer">CVV</label>

                <!-- 19. credit_card[rvv] (#orcer) -->
                <input placeholder="CVV" id="orcer" name="credit_card[rvv]" class="string required" maxlength="4" size="4" type="text" />
              </div>
            </div>
          </div>
          <div id="cart-totals">
            <div>
              <span class="label-total">cart total</span>
              <span class="field" id="subtotal">$148</span>
            </div>
            <div>
              <span class="label-total">ship &amp; handle</span>
              <span class="field" id="shipping">$10</span>
            </div>
            <div>
              <span class="label-total"><strong>order total</strong></span>
              <span><strong class="field" id="total">$158</strong></span>
            </div>
          </div>
          <p>
            <label class="has-checkbox terms">

              <!-- 20. order[terms] -->
              <input name="order[terms]" type="hidden" value="0" />

              <!-- 21. order[terms] (#order_terms) [OPTIONAL] -->
              <input class="checkbox" type="checkbox" value="1" name="order[terms]" id="order_terms" />I have read and agree to the <a href="http://www.supremenewyork.com/shop/terms">terms & conditions</a>, and accept the return policy<span class="terms-error">please agree to the terms</span></label>
          </p>

          <!-- 22. g-recaptcha-response -->
          <div class="g-recaptcha" data-callback="checkoutAfterCaptcha" data-sitekey="6LcLVm8UAAAAAIGVtKDG8bCfEvP2I-myOnJHowxn" data-size="invisible"></div>

          <!-- 23. credit_card[vval] (#numbc) -->
          <input id="numbc" name="credit_card[vval]" type="text" />
        </fieldset>
      </div>
    </div>
    <div id="cart-footer">
      <div id="pay">
        <p style=""></p>
        <input type="submit" name="commit" value="process payment" class="button " disable_with="please wait..." /><a class="button cancel" href="http://www.supremenewyork.com/shop">cancel</a></div>
    </div>
  </form>

<script>
$('#checkout_form').on('submit', (e) => {
  e.preventDefault();
  grecaptcha.execute();
});

function checkoutAfterCaptcha (token) {
  console.log(token);
  $.post('/checkout.json', $('#checkout_form').serialize()).done((data) => {
    console.log(data[0]);
    console.log(Object.keys(data[0]).length);

    console.log(data[1]);
    grecaptcha.reset();
  });
}

function creditCardTypeFromNumber (num) {
  num = num.replace(/[^\d]/g, '');
  if (num.match(/^5[1-5]\d/)) {
    return 'mastercard';
  } else if (num.match(/^4\d/) || num.match(/^4\d/)) {
    return 'visa';
  } else if (num.match(/^3[47]\d/)) {
    return 'american_express';
  } else if (num.match(/^35(28|29|[3-8]\d)\d$/)) {
    return 'jcb';
  }
  return 'UNKNOWN';
};

// jquery-mask-plugin
$('#order_tel').mask('000-000-0000', {
  autoclear: false
});

$('#cnb, #nnaerb').on('keyup', function(e) {
  e.preventDefault();

  const field = $(this);
  const cctype = creditCardTypeFromNumber(field.val());

  if (cctype === "UNKNOWN") {
    $('#cnb, #nnaerb').unmask();
    return;
  }

  if (cctype === "american_express") {
    $('#cnb, #nnaerb').mask('9999 999999 99999', {
      autoclear: false
    }).trigger('focus.mask');
  } else {
    $('#cnb, #nnaerb').mask('9999 9999 9999 9999', {
      autoclear: false
    }).trigger('focus.mask');
  }
  return $('#cart-vval, #cvc').removeClass('visa').removeClass('master').removeClass('american_express').addClass(cctype);
});

// jquery-validation
var FIRST_AND_LAST_NAME_FORMAT = /^[A-Za-z\-\.&#39;]+( +[A-Za-z\-\.&#39;]+)+$/;
var TEL_FORMAT = /^[0-9]{10}$/;
var STATE_FORMAT = /^[a-zA-Z]{2}$/;
var CANADA_ZIP = /[ABCEGHJKLMNPRSTVXY]\d[A-Z] ?\d[A-Z]\d/;
var US_ZIP = /^\d{5}([\-]\d{4})?$/;

$('#checkout_form').validate({
  onsubmit: false,
  errorElement: 'span',
  highlight: function(element, errorClass, validClass) {
    return $(element).parent().addClass('error');
  },
  unhighlight: function(element, errorClass, validClass) {
    return $(element).parent().removeClass('error');
  },
  errorPlacement: function(error, element) {
    return error.appendTo(element.parent());
  },
  errorClass: 'error js',
  success: function(label) {
    return label.remove();
  }
});
$.validator.addMethod('first_and_last', function(value) {
  return FIRST_AND_LAST_NAME_FORMAT.test(value);
}, 'must contain first and last name');

$.validator.addMethod('tel', function(value) {
  return TEL_FORMAT.test(value.replace(/-|\(|\)|\s/g, ''));
}, 'must be a 10-digit phone number');

$.validator.addMethod('zipcode', function(value) {
  if ($("#order_billing_country").val() === 'CANADA') {
    return CANADA_ZIP.test(value.toUpperCase());
  } else {
    return US_ZIP.test(value);
  }
}, function() {
  if ($("#order_billing_country").val() === 'CANADA') {
    return 'must be a valid canadian zipcode';
  } else {
    return "must be a 5 digit US zipcode";
  }
});

// updateShipping
$("#order_billing_country, #order_billing_state").on('change', updateShipping);
function updateShipping () {

  if (!window.update_shipping_cnt) {
    window.update_shipping_cnt = 0;
  }
  window.update_shipping_cnt += 1;
  if (window.update_shipping_cnt > 7) {
    return false;
  }

  const data = $('form#checkout_form')
    .serializeArray()
    .reduce((res, item) => {
      if (!/number|verification_value/.test(item.name)) {
        return Object.assign(res, { [item.name]: item.value })
      }
      return res;
    }, {});
  data['cnt'] = window.update_shipping_cnt;

  return $.ajax({
    url: "checkout.js",
    dataType: 'html',
    data,
    success: (data) => {
      console.log(JSON.parse(data));
    }
  });
};

</script>
</body>
</html>
